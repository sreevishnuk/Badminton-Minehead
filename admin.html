<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="admin-bg">

  <!-- ✅ SECURITY CHECK — PLACED AT VERY TOP OF BODY -->
  <script>
    // Immediately log that this script is running
    console.log("[SECURITY] Running inline auth check...");

    // Load Firebase dynamically
    const loadFirebaseAndCheckAuth = async () => {
      try {
        // Import Firebase modules dynamically
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js");
        const { getAuth, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js");

        // Your Firebase config
        const firebaseConfig = {
          apiKey: "AIzaSyBQvr257MnUMdv-i4VkgjaGUPnSho3F_x0",
          authDomain: "minehead-badminton-tournament.firebaseapp.com",
          projectId: "minehead-badminton-tournament",
          storageBucket: "minehead-badminton-tournament.appspot.com",
          messagingSenderId: "237720155580",
          appId: "1:237720155580:web:8faed76ef425f262d727b9",
          measurementId: "G-RG7J53MLE2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        console.log("[SECURITY] Firebase initialized. Checking auth state...");

        // Check auth state
        onAuthStateChanged(auth, (user) => {
          if (user) {
            console.log("[SECURITY] Authenticated user:", user.email);
          } else {
            console.log("[SECURITY] No user. Redirecting to adminlogin.html");
            window.location.href = 'adminlogin.html';
          }
        });

      } catch (err) {
        console.error("[SECURITY] Failed to load Firebase or check auth:", err);
        // Don't break the page — but show error for debugging
        document.body.innerHTML = '<h2 style="color:red;text-align:center;">Security Check Failed</h2><pre>' + err.message + '</pre>';
      }
    };

    // Run the check immediately
    loadFirebaseAndCheckAuth();
  </script>

  <!-- Rest of your admin page -->
  <nav class="admin-nav">
    <img src="badmintonlogo.png" alt="Badminton Logo" class="logo-sm" />
    <span class="admin-title">Admin Dashboard</span>
    <button class="btn-secondary" onclick="logoutAdmin()">Logout</button>
  </nav>

  <div class="admin-container">
    <section>
      <button class="btn-primary" onclick="toggleRegistration()">Enable/Disable Registration</button>
      <button class="btn-accent" onclick="generateFixtures()">Generate Fixtures</button>
    </section>

    <section>
      <h2>Player Control</h2>
      <div id="players-list">Loading players...</div>
    </section>

    <section>
      <h2>Manage Fixtures</h2>
      <div id="edit-fixtures">Loading fixtures...</div>
    </section>

    <section>
      <h2>Fixtures & Results</h2>
      <div id="enter-scores">Loading score entry...</div>
    </section>
  </div>

  <script src="script.js" type="module"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof loadPlayers === 'function') loadPlayers();
      if (typeof loadFixturesAdmin === 'function') loadFixturesAdmin();
    });
  </script>
</body>
</html>
